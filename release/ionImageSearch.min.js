angular.module("ion-image-search",["ionic"]).directive("hideOnFail",function(){return{link:function a(b,c){c.bind("error",function(){angular.element(this).parent().css("display","none")})}}}).service("$webImageSelector",["$rootScope","$ionicModal","$injector","$q","$log","$timeout","ionImageSearchProviders","ionImageSearchDefaultConfiguration",function(i,c,r,v,p,z,d,h){var j=d;var a=function(){return j};var b=h;var l=b;var m=null;var g=null;var o=null;var t=1;var n=0;var y=null;var k=null;var A='<form name="web-search"><ion-modal-view><div class="bar bar-header item-input-inset"><input type="submit" ng-click="submitSearch()" style="position: absolute; left: -9999px; width: 1px; height: 1px;"/><button class="button button-icon" ng-click="onCancel()"><i class="ion-android-arrow-back"></i></button><label class="item-input-wrapper"><i class="icon ion-ios-search placeholder-icon"></i><input type="search" placeholder="Search..." ng-model="search.text"></label><button class="button button-stable button-clear" ng-click="onClearSearch()"><i class="ion-close-round"></i></button></div><ion-content class="has-header" ng-class="{\'ion-web-image-content\': displayedImages.length==0}"><div ng-show="!searching&&(displayedImages.length==0)" class="ion-web-image-no-images">No results</div><div ng-show="searching&&(displayedImages.length==0)" class="ion-web-image-no-images"><ion-spinner class="ios"></ion-spinner></div><div ng-hide="displayedImages.length==0"><ul><li class="ion-web-image-li" ng-hide="image.hide" ng-repeat="image in displayedImages track by $index" ng-click="onImageClicked(image)"><img class="ion-web-image-image" hide-on-fail ng-src="{{image.url}}"></li></ul><ion-infinite-scroll ng-if="!hideInfiniteScroll" on-infinite="loadMoreImages()" distance="1%" immediate-check="true"></ion-infinite-scroll></div></ion-content></ion-modal-view></form>';var x=function(){t=1;n=0;k=null;o.search={};o.search.text="";o.displayedImages=[];o.searching=false};var u=function(B){try{l={};m=null;if(B){for(var C in B){if(B.hasOwnProperty(C)){l[C]=B[C]}}for(var E in b){if(b.hasOwnProperty(E)){if(l[E]===undefined){l[E]=b[E]}}}}else{q()}if(l&&l.searchProviders.length>0){f(l.searchProviders,l)}else{q()}}catch(D){p.error("Failed to set providers, using defaults");q()}};var q=function(){l=b;f(l.searchProviders,l)};var f=function(B,E){var D=false;var C=new (r.get(B[0]))(E);if(C){m={provider:C,index:0,name:l.searchProviders[0]};D=true}else{p.error("Failed to inject specified search provider");D=false}return D};var e=function(){try{var B=function(F){if(F&&F.length>0){F.forEach(function(G){o.displayedImages.push(G)})}};var D=function(F){return(typeof F.query==="function")&&(typeof F.getPageSize==="function")};var C=function(){if(n>=l.maxSuccessiveFails){var G=m.index+1;if(G<l.searchProviders.length){p.warn("Switching search providers to: "+l.searchProviders[G]);var F=new (r.get(l.searchProviders[G]))(l);if(D(F)){m={provider:F,index:G,name:l.searchProviders[G]};n=0}else{throw new Error("Illegal Search Provider: "+l.searchProviders[G]+". Please see ReadMe for expected provider")}}else{o.hideInfiniteScroll=true}}};o.loadMoreImages=function(){try{if(k&&k.length>0){var G=m.provider;p.info("loadedImages from: "+t+" to: "+(t+G.getPageSize()));G.query(k,t).then(function(H){t+=m.provider.getPageSize();B(H);p.debug("loaded images successfully");z(function(){o.$broadcast("scroll.infiniteScrollComplete")},100)},function(){p.debug("failed loading images");n++;C();if(!o.hideInfiniteScroll&&o.displayedImages.length==0){o.loadMoreImages()}else{o.$broadcast("scroll.infiniteScrollComplete");o.searching=false}})}else{p.debug("Empty search submitted")}}catch(F){p.error(F.toString())}};o.submitSearch=function(){try{cordova.plugins.Keyboard.close()}catch(F){p.warn("failed to close keyboard")}o.displayedImages=[];n=0;t=1;o.hideInfiniteScroll=false;k=o.search.text;o.searching=true;o.loadMoreImages()};o.onClearSearch=function(){k=null;o.search.text=""};o.onCancel=function(){g.remove();g=null;y.reject()};o.onHideImage=function(F){F.hide=true};o.onImageClicked=function(F){g.remove();g=null;y.resolve({image:F,searchString:k})}}catch(E){p.fatal("Failed to set scope, ionImageSearch will not work!")}};var s=function(C,B){if(!B){B=i.$new()}o=B;e();u(C);x()};var w=function(){y=v.defer();if(!o){p.warn("ionImageSearch not initialized, using defaults");s(null,i.$new())}x();var B=(Object.getOwnPropertyNames(j)).length>0;if(B){if(!g){g=c.fromTemplate(A,{scope:o,animation:"slide-in-up"})}o.hideInfiniteScroll=false;g.show()}else{p.error("Please make sure your configuration has service providers to use");y.reject("Please make sure your configuration has service providers to use")}return y.promise};return{init:s,show:w,getSearchProviderOptions:a}}]);angular.module("ion-image-search").factory("googleSearch",["$injector","$q","$http","$log",function(i,e,h,j){var g=function(l){var k=this;if(!l||!l.fileType||!l.imgSize){throw new Error("Search provider must be constructed with proper configuration")}k.configuration=l};var b=i.get("googleParams");var c=function(k){return(k&&k.data)};var d=function(l){var m=[];for(var k in l){if(l.hasOwnProperty(k)){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}}return m.join("&")};var f=function(l,m){var k={};k.q=l;k.key=b.key;k.safe="high";k.cx=b.customSearch;k.searchType="image";k.fileType=this.configuration.fileType;k.imgSize=this.configuration.imgSize;k.start=m;return b.address+d(k)};var a=function(l){var k=[];if(l.items&&l.items.length>0){l.items.forEach(function(m){k.push({url:m.link})})}else{j.warn("returned no images")}return k};g.prototype.query=function(n,o){var k=e.defer();var m={};var l=f.call(this,n,o);h.get(l,m).then(function(q){if(c(q)){var p=a(q.data,k);if(p&&p.length>0){k.resolve(p)}else{k.reject()}}else{j.warn("returned no data");k.reject()}},function(p){var q=(p&&p.data&&p.data.error)?p.data.error.message:((p)?p.toString():"no message");j.warn("Failed getting images "+q);k.reject()});return k.promise};g.prototype.getPageSize=function(){return b.pageSize};return g}]);angular.module("ion-image-search").factory("bingSearch",["$injector","$q","$http","$log",function(i,e,g,j){var h=function(l){var k=this;if(!l||!l.fileType||!l.imgSize){throw new Error("Search provider must be constructed with proper configuration")}k.configuration=l};var b=i.get("bingParams");var c=function(k){return(k&&k.data&&k.data.d)};var d=function(l){var m=[];for(var k in l){if(l.hasOwnProperty(k)){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}}return m.join("&")};var f=function(m,n){var l={};l.Query="'"+m+"'";l.Adult="'Strict'";var k=this.configuration.imgSize;k=k.charAt(0).toUpperCase()+k.slice(1);l.ImageFilters="'Size:"+k.toString()+"+Aspect:Square'";l["$skip"]=n;return b.address+d(l)};var a=function(l){var k=[];if(l.d&&l.d.results&&l.d.results.length>0){l.d.results.forEach(function(m){k.push({url:m.Thumbnail.MediaUrl})})}else{j.warn("returned no images")}return k};h.prototype.query=function(n,o){var k=e.defer();var m={};m.headers={Authorization:b.auth};var l=f.call(this,n,o);g.get(l,m).then(function(q){if(c(q)){var p=a(q.data,k);if(p&&p.length>0){k.resolve(p)}else{k.reject()}}else{j.warn("returned no data");k.reject()}},function(p){var q=(p&&p.data)?p.data:"No Error";j.warn("Failed getting images "+q);k.reject()});return k.promise};h.prototype.getPageSize=function(){return b.pageSize};return h}]);angular.module("ion-image-search").factory("flickrSearch",["$injector","$q","$http","$log",function(i,e,h,j){var g=function(l){var k=this;if(!l||!l.fileType||!l.imgSize){throw new Error("Search provider must be constructed with proper configuration")}k.configuration=l};var a=i.get("flickrParams");var c=function(k){return(k&&k.data&&k.data.stat!=="fail")};var d=function(l){var m=[];for(var k in l){if(l.hasOwnProperty(k)){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}}return m.join("&")};var f=function(l,m){var k={};k.api_key=a.key;k.text=l;k.privacy_filter="public";k.content_type="7";k.media="photos";k.format="json";k.per_page=a.pageSize;k.page=m;k.extras="url_m";return a.address+d(k)};var b=function(m){if(m.photos&&m.photos.photo&&m.photos.photo.length>0){var k=[];var l="url_m";m.photos.photo.forEach(function(n){k.push({url:n[l]})})}else{j.warn("returned no images")}return k};g.prototype.query=function(n,o){var k=e.defer();var m={};var l=f.call(this,n,o);h.get(l,m).then(function(q){q.data=q.data.replace("jsonFlickrApi(","");q.data=q.data.slice(0,-1);q.data=JSON.parse(q.data);if(c(q)){var p=b(q.data,k);if(p&&p.length>0){k.resolve(p)}else{k.reject()}}else{j.warn("returned no data");if(q.data.stat==="fail"){j.warn("Error: "+q.data.message)}k.reject()}},function(p){var q=(p&&p.data)?p.data:"No Error";j.warn("Failed getting images "+q);k.reject()});return k.promise};g.prototype.getPageSize=function(){return a.pageSize};return g}]);